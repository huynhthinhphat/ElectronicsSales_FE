<div class="user-content pt-[60px]">
    <div class="max-w-[1440px] mx-auto">
        <div class="mt-6">
            <div class="mx-auto px-4 sm:px-6 lg:px-16 py-2">
                <div class="mb-3">
                    <h1 class="text-xl font-bold text-gray-900 sm:text-2xl">
                        Thanh toán
                    </h1>
                </div>
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="h-full">
                                <div class="bg-white rounded-lg h-full p-4 border shadow-md">
                                    <h2 class="text-lg font-semibold mb-2">
                                        Phương thức thanh toán
                                    </h2>
                                    <div class="space-y-1">
                                        <label
                                            class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded">
                                            <div class="relative flex items-center">
                                                <input type="radio" name="payment" [(ngModel)]="paymentMethod"
                                                    class="appearance-none w-5 h-5 rounded-full border-2 border-gray-300  checked:border-[#FF8900] checked:bg-[#FF8900]  transition-all duration-200 cursor-pointer"
                                                    value="COD" checked="">
                                                <div
                                                    class="absolute w-5 pointer-events-none flex justify-center items-center">
                                                    <i class="fa-solid fa-check w-3 h-3 text-white text-[.8em]"></i>
                                                </div>
                                            </div>
                                            <img src="http://res.cloudinary.com/dpxcvonet/image/upload/v1742182099/electronics-sales/d55fbupi8hz7tpl4gqa3.png"
                                                alt="Thanh toán khi nhận hàng" class="h-6 w-6">
                                            <span class="text-base">
                                                Thanh toán khi nhận hàng
                                            </span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded">
                                            <div class="relative flex items-center">
                                                <input type="radio" name="payment" [(ngModel)]="paymentMethod"
                                                    class="appearance-none w-5 h-5 rounded-full border-2 border-gray-300  checked:border-[#FF8900] checked:bg-[#FF8900]  transition-all duration-200 cursor-pointer"
                                                    value="MOMO">
                                                <div
                                                    class="absolute w-5 pointer-events-none flex justify-center items-center">
                                                    <i class="fa-solid fa-check w-3 h-3 text-white text-[.8em]"></i>
                                                </div>
                                            </div>
                                            <img src="http://res.cloudinary.com/dpxcvonet/image/upload/v1742182099/electronics-sales/i8rvfmrr1dqh3xt8bdzh.png"
                                                alt="momo" class="h-6 w-6">
                                            <span class="text-base">
                                                MOMO
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="h-full">
                                <div class="bg-white rounded-lg h-full p-4 border shadow-md">
                                    <h2 class="text-lg font-semibold mb-2">
                                        Vận chuyển
                                    </h2>
                                    <div class="space-y-1">
                                        <label (click)="updatePriceOfDelivery(priceOfDelivery)"
                                            class="flex items-center justify-between p-2 border rounded cursor-pointer hover:border-orange-500">
                                            <div class="flex items-center gap-3 text-base">
                                                <div class="relative flex items-center">
                                                    <input type="radio" name="shipping" [(ngModel)]="deliveryMethod"
                                                        class="appearance-none w-5 h-5 rounded-full border-2 border-gray-300  checked:border-[#FF8900]  checked:bg-[#FF8900]   transition-all duration-200 cursor-pointer"
                                                        value="FAST_DELIVERY" checked="">
                                                    <div
                                                        class="absolute w-5 pointer-events-none flex justify-center items-center">
                                                        <i class="fa-solid fa-check w-3 h-3 text-white text-[.8em]"></i>
                                                    </div>
                                                </div>
                                                <img src="http://res.cloudinary.com/dpxcvonet/image/upload/v1742182099/electronics-sales/ftm8nawmhyqglfnfmgfw.png"
                                                    alt="Giao hàng nhanh" class="h-5">
                                                <div class="text-sm font-medium">
                                                    <div>
                                                        Giao hàng nhanh <br>
                                                        <span class="text-[13px]">
                                                            (Hỗ trợ phí ship mọi đơn)
                                                        </span>
                                                    </div>
                                                    <div *ngIf="fromEstimateDate && toEstimateDate"
                                                        class="text-gray-500 font-medium text-[12px]">
                                                        Nhận hàng vào {{fromEstimateDate| date: 'dd/MM'}} -
                                                        {{toEstimateDate| date: 'dd/MM'}}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="font-medium">
                                                    {{priceOfDelivery | currency:'VND':'symbol':'1.0-0':'vi'}}
                                                </span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hidden lg:block">
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="hidden md:block">
                                    <div class="p-4">
                                        <div class="max-h-[280px] overflow-y-auto">
                                            <div class="grid grid-cols-12 gap-4 sticky top-0 bg-white border-b">
                                                <div class="col-span-5 font-bold">Sản phẩm ({{products.length}})
                                                </div>
                                                <div class="col-span-2 text-gray-500 text-center">Phân loại</div>
                                                <div class="col-span-2 text-gray-500 text-center">Đơn giá</div>
                                                <div class="col-span-1 text-gray-500 text-center">SL</div>
                                                <div class="col-span-2 text-gray-500 text-center">Thành tiền</div>
                                            </div>
                                            <div class="grid grid-cols-12 gap-4 border-b p-2"
                                                *ngFor="let product of products">
                                                <div class="col-span-5 flex gap-3 items-center">
                                                    <div class="w-16 h-16 rounded-md overflow-hidden">
                                                        <img [src]='product.mainImageUrl' [alt]='product.name'
                                                            class="w-full h-full object-cover">
                                                    </div>
                                                    <div class="flex-1 font-medium">
                                                        <div class="flex items-center gap-1 text-[#FF8900] ">
                                                            <span>
                                                                {{product.sku}}
                                                            </span>
                                                        </div>
                                                        <h3 class="mb-1">
                                                            {{product.name}}
                                                        </h3>
                                                    </div>
                                                </div>
                                                <div class="col-span-2 flex items-center justify-center">
                                                    {{product.color}}
                                                </div>
                                                <div class="col-span-2 flex items-center justify-center gap-1">
                                                    {{product.priceAtTime| currency:'VND':'symbol':'1.0-0':'vi'}}
                                                </div>
                                                <div class="col-span-1 flex items-center justify-center">
                                                    {{product.quantity}}
                                                </div>
                                                <div class="col-span-2 flex items-center justify-end gap-1">
                                                    {{product.totalPrice | currency:'VND':'symbol':'1.0-0':'vi'}}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:w-[310px]">
                        <div class="lg:sticky lg:top-6 mt-4 lg:mt-0">
                            <div class="bg-white rounded-lg shadow-md">
                                <div class="p-4 border-b">
                                    <div class="mb-3 flex items-center justify-center gap-1">
                                        <svg stroke="currentColor" fill="currentColor" stroke-width="0"
                                            viewBox="0 0 1024 1024" class="h-5 w-5" height="1em" width="1em"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M854.6 289.1a362.49 362.49 0 0 0-79.9-115.7 370.83 370.83 0 0 0-118.2-77.8C610.7 76.6 562.1 67 512 67c-50.1 0-98.7 9.6-144.5 28.5-44.3 18.3-84 44.5-118.2 77.8A363.6 363.6 0 0 0 169.4 289c-19.5 45-29.4 92.8-29.4 142 0 70.6 16.9 140.9 50.1 208.7 26.7 54.5 64 107.6 111 158.1 80.3 86.2 164.5 138.9 188.4 153a43.9 43.9 0 0 0 22.4 6.1c7.8 0 15.5-2 22.4-6.1 23.9-14.1 108.1-66.8 188.4-153 47-50.4 84.3-103.6 111-158.1C867.1 572 884 501.8 884 431.1c0-49.2-9.9-97-29.4-142zM512 880.2c-65.9-41.9-300-207.8-300-449.1 0-77.9 31.1-151.1 87.6-206.3C356.3 169.5 431.7 139 512 139s155.7 30.5 212.4 85.9C780.9 280 812 353.2 812 431.1c0 241.3-234.1 407.2-300 449.1zm0-617.2c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176-78.8-176-176-176zm79.2 255.2A111.6 111.6 0 0 1 512 551c-29.9 0-58-11.7-79.2-32.8A111.6 111.6 0 0 1 400 439c0-29.9 11.7-58 32.8-79.2C454 338.6 482.1 327 512 327c29.9 0 58 11.6 79.2 32.8C612.4 381 624 409.1 624 439c0 29.9-11.6 58-32.8 79.2z">
                                            </path>
                                        </svg>
                                        <h2 class="font-semibold text-gray-500 text-lg">Ship đến</h2>
                                    </div>
                                    <app-skeleton-loader *ngIf="isLoading"></app-skeleton-loader>
                                    <div *ngIf="!isLoading && isInforFull" class="space-y-3">
                                        <div class="flex justify-end">
                                            <button (click)="showDialog()"
                                                class="text-[14px] text-[#FF8900] flex items-center gap-2 border !border-[#FF8900] px-3 py-0.5 cursor-pointer rounded-full hover:bg-[#FF8900] hover:text-white">
                                                Sửa thông tin
                                                <i class="fa-solid fa-pen text-[10px]"></i>
                                            </button>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="font-semibold text-gray-800">
                                                {{fullName}}
                                            </span>
                                            <span class="font-semibold text-gray-800">
                                                {{phoneNumber}}
                                            </span>
                                        </div>
                                        <div>
                                            <div class="text-gray-600 text-sm leading-relaxed">
                                                {{address}}
                                            </div>
                                        </div>
                                        <div>
                                            <span class="text-[14px] font-semibold">Ghi chú:</span>
                                            <textarea name="description" rows="3" cols="36" [(ngModel)]="noteForOrder"
                                                placeholder="Nhập thông tin mô tả (nếu cần)..."
                                                class="border outline-none text-[14px] px-0.5 placeholder:text-gray-500"></textarea>
                                        </div>
                                    </div>
                                    <div *ngIf="!isInforFull" class="text-center space-y-3">
                                        <p class="text-gray-500">Vui lòng cập nhật thông tin giao hàng</p>
                                        <button (click)="redirectUpdateInforUser()"
                                            class="flex items-center gap-2 mx-auto px-4 py-2 bg-[#FF8900] text-white rounded-lg hover:bg-orange-500 transition-colors cursor-pointer">
                                            <svg stroke="currentColor" fill="currentColor" stroke-width="0"
                                                viewBox="0 0 1024 1024" class="w-4 h-4" height="1em" width="1em"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M257.7 752c2 0 4-.2 6-.5L431.9 722c2-.4 3.9-1.3 5.3-2.8l423.9-423.9a9.96 9.96 0 0 0 0-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2a33.5 33.5 0 0 0 9.4 29.8c6.6 6.4 14.9 9.9 23.8 9.9zm67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z">
                                                </path>
                                            </svg>
                                            <span>Cập nhật thông tin</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4" *ngIf="isInforFull">
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center text-base">
                                            <span class="text-gray-600">Tạm tính</span>
                                            <div class="flex items-center gap-1">
                                                <span class="font-medium">
                                                    {{totalPriceTempOfOrder | currency:'VND':'symbol':'1.0-0':'vi'}}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center text-base">
                                            <span class="text-gray-600">Phí vận chuyển</span>
                                            <div class="flex items-center gap-1">
                                                <span class="font-medium">{{priceOfDelivery |
                                                    currency:'VND':'symbol':'1.0-0':'vi'}}</span>
                                            </div>
                                        </div>
                                        <div class="pt-4 border-t">
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-lg">Tổng tiền</span>
                                                <div class="flex items-baseline gap-1">
                                                    <span class="text-[#FF8900] text-2xl font-bold">
                                                        {{finalTotalPriceOfOrder |
                                                        currency:'VND':'symbol':'1.0-0':'vi'}}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6">
                                        <button [disabled]="!isInforFull" (click)="showAcceptDialog()"
                                            [ngClass]="{'!cursor-not-allowed !bg-orange-200': !isInforFull,'cursor-pointer bg-[#FF8900] hover:bg-orange-500': isInforFull}"
                                            class="w-full py-4 text-white text-lg font-medium rounded-lg transition-colors">
                                            Thanh toán ({{products.length}})
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div *ngIf="isShowDialog" class="fixed inset-0 bg-[rgba(0,0,0,0.3)] flex items-center justify-center z-50"
    (click)="showDialog()">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96" (click)="stopClickPropagation($event)">
        <h2 class="text-xl font-semibold mb-4">Nhập thông tin</h2>
        <small class="text-[red]">*Lưu ý: Thông tin giao hàng sau khi cập nhật chỉ có tác dụng cho hóa đơn hiện
            tại!</small>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1" for="fullName">Họ tên</label>
            <input type="text" [(ngModel)]="newFullName" placeholder="Nhập họ tên" id="fullName"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none placeholder:text-gray-500 placeholder:text-[14px] focus:ring focus:ring-orange-500" />
        </div>
        <div class="mb-3">
            <label class="block text-sm font-medium mb-1" for="phoneNumber">Số điện thoại</label>
            <input type="text" [(ngModel)]="newPhoneNumber" placeholder="Nhập số điện thoại" id="phoneNumber"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none placeholder:text-gray-500 placeholder:text-[14px] focus:ring focus:ring-orange-500" />
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-1">Địa chỉ</label>
            <div class="flex flex-col gap-3">
                <select (change)="getDistricts($event)"
                    class="cursor-pointer outline-none text-sm border px-3 py-3 rounded">
                    <option [value]="-1">Chọn tỉnh/thành phố</option>
                    <option *ngFor="let province of provinces" [value]="province.ProvinceID">
                        {{province.ProvinceName}}
                    </option>
                </select>
                <select [disabled]="districts.length === 0" (change)="getWards($event)"
                    class="outline-none text-sm border px-3 py-3 rounded"
                    [ngClass]="{'cursor-not-allowed text-gray-400 border-gray-400' : districts.length === 0,'cursor-pointer' : districts.length > 0}">
                    <option [value]="-1">Chọn quận/huyện</option>
                    <option *ngFor="let district of districts" [value]="district.DistrictID">
                        {{district.DistrictName}}
                    </option>
                </select>
                <select [disabled]="wards.length === 0" (change)="setIndexWards($event)"
                    class="outline-none text-sm border px-3 py-3 rounded"
                    [ngClass]="{'cursor-not-allowed text-gray-400 border-gray-400' : wards.length === 0,'cursor-pointer' : wards.length > 0}">
                    <option [value]="-1">Chọn xã/thị trấn</option>
                    <option *ngFor="let ward of wards" [value]="ward.WardID">
                        {{ward.WardName}}
                    </option>
                </select>
                <input type="text" [(ngModel)]="houseAddress" [disabled]="indexWard === -1"
                    class="text-sm break-words outline-none border border-[#FF8900] rounded-lg p-2"
                    [ngClass]="{'cursor-not-allowed text-gray-400 border-gray-400' : indexWard === -1,'cursor-text' : indexWard !== -1}"
                    placeholder="Nhập số nhà cụ thể">
            </div>
        </div>

        <div class="flex justify-end gap-2">
            <button (click)="saveNewInforForCurrentOrder()"
                class="cursor-pointer px-4 py-2 bg-orange-600 text-white rounded">Lưu</button>
        </div>
    </div>
</div>
<div *ngIf="isShowAcceptDialog" class="fixed inset-0 flex items-center justify-center bg-[rgba(0,0,0,0.3)] z-50"
    (click)="hiddenAcceptDialog()">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6 overflow-y-auto max-h-screen"
        (click)="stopClickPropagation($event)">
        <div class="flex flex-col items-center">
            <h2 class="text-center text-xl font-semibold mb-4">Xác nhận hóa đơn</h2>
            <small class="text-red-600">Tự xác nhận sau {{seconds}}s</small>
        </div>
        <div class="space-y-2 text-sm text-gray-700">
            <p>
                <span class="font-bold">Họ và tên: </span>
                <span>{{ fullName }}</span>
            </p>
            <p>
                <span class="font-bold">Số điện thoại: </span>
                <span>{{ phoneNumber }}</span>
            </p>
            <p>
                <span class="font-bold">Địa chỉ: </span>
                <span>{{ address }}</span>
            </p>
            <p>
                <span class="font-bold">Phương thức thanh toán: </span>
                <span>{{ getPaymentMethod }}</span>
            </p>
            <p>
                <span class="font-bold">Phương thức vận chuyển: </span>
                <span>{{ getDeliveryMethod }}</span>
            </p>
            <p>
                <span class="font-bold">Thời gian nhận hàng: </span>
                <span>{{ fromEstimateDate | date: 'dd/MM/yyyy' }} - {{toEstimateDate | date: 'dd/MM/yyyy'}}</span>
            </p>
        </div>
        <div class="w-full max-h-[40vh] overflow-auto">
            <table class="w-full mt-4 rounded-xl overflow-hidden shadow-md">
                <thead class="bg-gray-100 text-gray-700">
                    <tr>
                        <th class="px-4 py-2 text-center text-sm font-semibold">STT</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">Ảnh</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">Tên</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">Màu</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">Giá</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">SL</th>
                        <th class="px-4 py-2 text-center text-sm font-semibold">Thành tiền</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 min-h-0.5 overflow-y-hidden">
                    <tr *ngFor="let product of products; let i = index" class="hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm text-center">{{ i + 1 }}</td>
                        <td class="px-4 py-2">
                            <img [src]="product.mainImageUrl" [alt]="product.name"
                                class="w-16 h-16 object-cover rounded-md border border-gray-200" />
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            {{ product.name }}
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            {{ product.color }}
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            {{ product.priceAtTime | currency:'VND':'symbol':'1.0-0':'vi'}}
                        </td>
                        <td class="px-4 py-2 text-sm text-center">
                            {{ product.quantity }}
                        </td>
                        <td class="px-4 py-2 text-sm font-medium text-center">
                            {{ product.totalPrice | currency:'VND':'symbol':'1.0-0':'vi'}}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="flex justify-end">
            <span class="font-bold mr-2">Tổng tiền:</span> {{finalTotalPriceOfOrder |
            currency:'VND':'symbol':'1.0-0':'vi'}}
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button (click)="pay()"
                class="cursor-pointer px-4 py-2 border bg-white !border-orange-500 text-orange-500 rounded hover:bg-orange-500 hover:text-white">
                Xác nhận
            </button>
        </div>
    </div>
</div>